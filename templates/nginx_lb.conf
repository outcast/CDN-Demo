error_log /var/log/nginx/error.log;

upstream caches {
    zone caches 64k;
    #state /var/lib/nginx/state/http_backend.state;
    %{ for node in jsondecode(cache_nodes) ~}
server ${node.ipv4_address_private};
    %{ endfor ~}

}

match health_conditions {
    status 200;
}

server {

    access_log /var/log/nginx/lb-access.log combined;
    listen 80;

    location / {
        proxy_set_header Host $host;
        proxy_pass http://caches;
        add_header WORKER $upstream_addr;
        health_check match=health_conditions fails=2 uri=/ubuntu/;
    }
}
